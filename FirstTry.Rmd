---
title: "Shiny"
author: "Owen Wright"
date: "12/11/2018"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(igraph)
library(tm)
library(SnowballC)
library(wordcloud)
library(RColorBrewer)
library(visNetwork)
library(networkD3)
library(plotly)
library(tidyr)
```

```{r, echo=FALSE}
all_activities <- read_csv("All_Activities.csv")
all_kudos <- read_csv("AllKudos.csv")
paces_prs <- read_csv("Paces_PRs.csv")
kudos_match <- read_csv("kudos_match.csv")
```


```{r, echo=FALSE}
inputPanel(
  selectInput("variable", label = "x-axis variables:",
    choices = c("Mileage" = "total",
                "Average Pace" = "avg_pace",
                "Average Distance" = "avg_distance",
                "# of 12+ mi runs" = "num_long",
                "# of easy runs" = "real_easy",
                "# of fast runs" = "tempo"), selected="total")
)

renderPlotly(
    ggplot(data=paces_prs, mapping=aes_string(x=input$variable, y="improvement", color="name")) + 
      geom_point())
```
There weren't enough athletes to make any true statistical inferences, but we can see even in this limited graph that generally those who put in greater miles, had more runs at faster pace, and everything else that would be expected to be correlated to improvement, did improve the most from one season to the next.  


```{r, echo=FALSE}
g <- ggplot(data = all_activities, mapping = aes(x = pace)) +
  geom_density(aes(fill=name))
ggplotly(g)
```
Here we can see the distribution of paces for each runner.  It is generally thought that those who spend more time at very easy paces and hard paces, see the greatest training benefit.  Again, there isn't enough data to make statistical inferences, but it is cool to be able to compare athlete to athlete and their pace distributions.  


```{r, echo=FALSE}
d<-all_activities%>%
  group_by(name)%>%
  ggplot(aes(x=date, y=pace, color=name))+
  geom_smooth(se=FALSE)
ggplotly(d)
```
Here we can see each runner's average pace over time from the summer through the fall.  We can see easily who was running hard early in the summer.  


Clicking on each runner above will show you some more athlete-specific stats, where we can see reasons for why their data may seem curious


```{r}
juM<-all_activities%>%
  mutate(month=as.numeric(str_sub(date, 6, 7)))%>%
  filter(name=="Justin")%>%
  group_by(month)%>%
  summarise(total=sum(miles))%>%
  ggplot(aes())+
  geom_bar(aes(x=month, y=total), stat="identity")
```

```{r}
jaM<- all_activities%>%
  mutate(month=as.numeric(str_sub(date, 6, 7)))%>%
  filter(name=="Jackson")%>%
  group_by(month)%>%
  summarise(total=sum(miles))%>%
  ggplot(aes())+
  geom_bar(aes(x=month, y=total), stat="identity")
```

```{r}
moM <- all_activities%>%
  mutate(month=as.numeric(str_sub(date, 6, 7)))%>%
  filter(name=="Mowgli")%>%
  group_by(month)%>%
  summarise(total=sum(miles))%>%
  ggplot(aes())+
  geom_bar(aes(x=month, y=total), stat="identity")
```
Here we have some insight as to why Mowgli's pace distribution graph was sinusoidal.  His mileage dropped significantly during this time perriod when his average pace dropped.  This indiciates some sort of injury, so it's possible that he was still trying to run on hard days while taking easy days off entirely.


```{r}
elM <- all_activities%>%
  mutate(month=as.numeric(str_sub(date, 6, 7)))%>%
  filter(name=="Elliot")%>%
  group_by(month)%>%
  summarise(total=sum(miles))%>%
  ggplot(aes())+
  geom_bar(aes(x=month, y=total), stat="identity")
``` 
It can be seen here that Elliot did not begin using Strava until the summer was over.  This tells us both that his count for total miles is low, and that his pace distribution is skewed to be a little fast, since most athletes do the bulk of their training above 7:00 per mile during the summer months


```{r}
biM <- all_activities%>%
  mutate(month=as.numeric(str_sub(date, 6, 7)))%>%
  filter(name=="Bill")%>%
  group_by(month)%>%
  summarise(total=sum(miles))%>%
  ggplot(aes())+
  geom_bar(aes(x=month, y=total), stat="identity")
``` 

```{r}
plM <- all_activities%>%
  mutate(month=as.numeric(str_sub(date, 6, 7)))%>%
  filter(name=="Plumb")%>%
  group_by(month)%>%
  summarise(total=sum(miles))%>%
  ggplot(aes())+
  geom_bar(aes(x=month, y=total), stat="identity")
```

```{r}
fiM <- all_activities%>%
  mutate(month=as.numeric(str_sub(date, 6, 7)))%>%
  filter(name=="Finn")%>%
  group_by(month)%>%
  summarise(total=sum(miles))%>%
  ggplot(aes())+
  geom_bar(aes(x=month, y=total), stat="identity")
```

```{r, echo = FALSE}
inputPanel(
  selectInput("runner", label="Runner", choices = c(Justin="justin",Jackson = "jackson", Bill = "bill", Finn = "finn", Plumb = "plumb", Elliot = "elliot", Mowgli = "mowgli")
))

output$myp <- renderPlot({
  if(input$runner =="justin"){
    all_activities%>%
  mutate(month=as.numeric(str_sub(date, 6, 7)))%>%
  filter(name=="Justin")%>%
  group_by(month)%>%
  summarise(total=sum(miles))%>%
  ggplot(aes())+
  geom_bar(aes(x=month, y=total), stat="identity")
    
  }
  else if(input$runner=="jackson"){
  all_activities%>%
  mutate(month=as.numeric(str_sub(date, 6, 7)))%>%
  filter(name=="Jackson")%>%
  group_by(month)%>%
  summarise(total=sum(miles))%>%
  ggplot(aes())+
  geom_bar(aes(x=month, y=total), stat="identity")
    
  }
  
  else if(input$runner=="bill"){
    all_activities%>%
  mutate(month=as.numeric(str_sub(date, 6, 7)))%>%
  filter(name=="Bill")%>%
  group_by(month)%>%
  summarise(total=sum(miles))%>%
  ggplot(aes())+
  geom_bar(aes(x=month, y=total), stat="identity")
  }
  else if(input$runner =="finn"){
    all_activities%>%
  mutate(month=as.numeric(str_sub(date, 6, 7)))%>%
  filter(name=="Finn")%>%
  group_by(month)%>%
  summarise(total=sum(miles))%>%
  ggplot(aes())+
  geom_bar(aes(x=month, y=total), stat="identity")
  }
  else if(input$runner == "plumb"){
    all_activities%>%
  mutate(month=as.numeric(str_sub(date, 6, 7)))%>%
  filter(name=="Plumb")%>%
  group_by(month)%>%
  summarise(total=sum(miles))%>%
  ggplot(aes())+
  geom_bar(aes(x=month, y=total), stat="identity")
  }
  else if(input$runner == "elliot"){
   all_activities%>%
  mutate(month=as.numeric(str_sub(date, 6, 7)))%>%
  filter(name=="Elliot")%>%
  group_by(month)%>%
  summarise(total=sum(miles))%>%
  ggplot(aes())+
  geom_bar(aes(x=month, y=total), stat="identity")
  }
  else if(input$runner == "mowgli"){
    all_activities%>%
  mutate(month=as.numeric(str_sub(date, 6, 7)))%>%
  filter(name=="Mowgli")%>%
  group_by(month)%>%
  summarise(total=sum(miles))%>%
  ggplot(aes())+
  geom_bar(aes(x=month, y=total), stat="identity")
  }
  
})

plotOutput("myp",height=500,width = 600)


```


```{r}
jus_type<-paces_prs%>%
  filter(name=="Justin")%>%
  gather('tempo':'real_easy', key="run_type", value="num_runs")%>%
  ggplot()+
  geom_bar(aes(x=run_type, y=num_runs, fill=run_type), stat="identity", show.legend=FALSE)
jus_type

jac_type<-paces_prs%>%
  filter(name=="Jackson")%>%
  gather('tempo':'real_easy', key="run_type", value="num_runs")%>%
  ggplot()+
  geom_bar(aes(x=run_type, y=num_runs, fill=run_type), stat="identity", show.legend=FALSE)
jac_type

mow_type<-paces_prs%>%
  filter(name=="Mowgli")%>%
  gather('tempo':'real_easy', key="run_type", value="num_runs")%>%
  ggplot()+
  geom_bar(aes(x=run_type, y=num_runs, fill=run_type), stat="identity", show.legend=FALSE)
ow_type

bil_type<-paces_prs%>%
  filter(name=="Bill")%>%
  gather('tempo':'real_easy', key="run_type", value="num_runs")%>%
  ggplot()+
  geom_bar(aes(x=run_type, y=num_runs, fill=run_type), stat="identity", show.legend=FALSE)
bil_type

ell_type<-paces_prs%>%
  filter(name=="Elliot")%>%
  gather('tempo':'real_easy', key="run_type", value="num_runs")%>%
  ggplot()+
  geom_bar(aes(x=run_type, y=num_runs, fill=run_type), stat="identity", show.legend=FALSE)
ell_type

bir_type<-paces_prs%>%
  filter(name=="Birdo")%>%
  gather('tempo':'real_easy', key="run_type", value="num_runs")%>%
  ggplot()+
  geom_bar(aes(x=run_type, y=num_runs, fill=run_type), stat="identity", show.legend=FALSE)
bir_type

plu_type<-paces_prs%>%
  filter(name=="Plumb")%>%
  gather('tempo':'real_easy', key="run_type", value="num_runs")%>%
  ggplot()+
  geom_bar(aes(x=run_type, y=num_runs, fill=run_type), stat="identity", show.legend=FALSE)
plu_type

fin_type<-paces_prs%>%
  filter(name=="Finn")%>%
  gather('tempo':'real_easy', key="run_type", value="num_runs")%>%
  ggplot()+
  geom_bar(aes(x=run_type, y=num_runs, fill=run_type), stat="identity", show.legend=FALSE)
fin_type
```



The goal was to create heatmaps for each runner for everywhere that they ran using the gps files, but the files were simply too big to handle on the R server.  Once converted from gps to csv file, they were simply massive.  
#Proof of concept here


#Word cloud function
```{r}
word <- function(runner, runner_n, runner_des){
file.remove("out.txt")
for(i in 1:count(runner)[[1]]){
  write(runner_n[i], file="out.txt", append=TRUE)
  write(runner_des[i],file="out.txt",append=TRUE)
}

filePath <- "out.txt"
text <- readLines(filePath)
docs <- Corpus(VectorSource(text))
toSpace <- content_transformer(function (x , pattern ) gsub(pattern, " ", x))
docs <- tm_map(docs, toSpace, "/")
docs <- tm_map(docs, toSpace, "@")
docs <- tm_map(docs, toSpace, "\\|")
# Convert the text to lower case
docs <- tm_map(docs, content_transformer(tolower))
# Remove numbers
docs <- tm_map(docs, removeNumbers)
# Remove english common stopwords
docs <- tm_map(docs, removeWords, stopwords("english"))
# Remove your own stop word
# specify your stopwords as a character vector
docs <- tm_map(docs, removeWords, c("blabla1", "blabla2")) 
# Remove punctuations
docs <- tm_map(docs, removePunctuation)
# Eliminate extra white spaces
docs <- tm_map(docs, stripWhitespace)
# Text stemming
# docs <- tm_map(docs, stemDocument)
dtm <- TermDocumentMatrix(docs)
m <- as.matrix(dtm)
v <- sort(rowSums(m),decreasing=TRUE)
d <- data.frame(word = names(v),freq=v)
set.seed(1234)
wordcloud(words = d$word, freq = d$freq, min.freq = 5,
          max.words=200, random.order=FALSE, rot.per=0.25, 
          colors=brewer.pal(8, "Dark2"))
}

#word(all_activities, all_activities$name, all_activities$description)

inputPanel(
  selectInput("runner_c", label="Runner", choices = c(Justin="justin",Jackson = "jackson", Bill = "bill", Finn = "finn", Plumb = "plumb", Elliot = "elliot", Mowgli = "mowgli")
))


renderPlot({all_activities %>%
  filter(name == "Jackson") %>%
  word(all_activities, all_activities$name, all_activities$description)
})
```

